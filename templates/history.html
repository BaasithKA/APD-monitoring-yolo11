<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detection History</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ°Ô∏è</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style> 
        body { background-color: #f8f9fa; } 
        .card { border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .modal-body img { max-width: 100%; height: auto; }
        .pagination .page-link { color: #0d6efd; }
        .pagination .page-item.active .page-link { z-index: 3; color: #fff; background-color: #0d6efd; border-color: #0d6efd; }
        .pagination .page-item.disabled .page-link { color: #6c757d; }
    </style>
</head>
<body>
    <nav class="navbar bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand text-primary fw-bold" href="/"><i class="bi bi-shield-check"></i> APD Monitoring System</a>
            <div>
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary"><i class="bi bi-camera-video"></i> Live Feed</a>
                <a href="{{ url_for('history') }}" class="btn btn-primary"><i class="bi bi-clock-history"></i> History</a>
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary"><i class="bi bi-bar-chart-fill"></i> Dashboard</a>
            </div>
        </div>
    </nav>
    <main class="container my-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-0">Detection History</h2>
                <p class="text-muted mb-0">Log lengkap dari semua peristiwa deteksi APD.</p>
            </div>
            <div>
                <a id="exportBtn" href="{{ url_for('export_csv') }}" class="btn btn-secondary"><i class="bi bi-download"></i> Ekspor ke CSV</a>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <form method="get" action="{{ url_for('history') }}" class="row g-3 align-items-end">
                    <div class="col-lg-4">
                        <label for="search" class="form-label">Cari Objek</label>
                        <input type="search" id="search" name="search" class="form-control" placeholder="Contoh: helmet" value="{{ search_query or '' }}">
                    </div>
                    <div class="col-lg-2">
                        <label for="status" class="form-label">Status</label>
                        <select id="status" name="status" class="form-select">
                            <option value="">Semua Status</option>
                            <option value="Lengkap" {% if status_filter == 'Lengkap' %}selected{% endif %}>Lengkap</option>
                            <option value="Tidak Lengkap" {% if status_filter == 'Tidak Lengkap' %}selected{% endif %}>Tidak Lengkap</option>
                        </select>
                    </div>
                    <div class="col-lg-2">
                        <label for="start_date" class="form-label">Dari Tanggal</label>
                        <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date or '' }}">
                    </div>
                    <div class="col-lg-2">
                        <label for="end_date" class="form-label">Sampai Tanggal</label>
                        <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date or '' }}">
                    </div>
                    <div class="col-lg-2 d-grid">
                        <button type="submit" class="btn btn-primary"><i class="bi bi-funnel-fill"></i> Filter</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="row g-4 mb-4">
             <div class="col-md-3"><div class="card text-center"><div class="card-body"><h6 class="card-title text-success">Lengkap</h6><p class="fs-2 fw-bold mb-0">{{ stats.complete_detections }}</p></div></div></div>
            <div class="col-md-3"><div class="card text-center"><div class="card-body"><h6 class="card-title text-danger">Tidak Lengkap</h6><p class="fs-2 fw-bold mb-0">{{ stats.incomplete_detections }}</p></div></div></div>
            <div class="col-md-3"><div class="card text-center"><div class="card-body"><h6 class="card-title text-info">Hari Ini</h6><p class="fs-2 fw-bold mb-0">{{ stats.today_detections }}</p></div></div></div>
            <div class="col-md-3"><div class="card text-center"><div class="card-body"><h6 class="card-title text-muted">Total (Filter)</h6><p class="fs-2 fw-bold mb-0">{{ stats.total_records }}</p></div></div></div>
        </div>

        <div class="card">
            <div class="card-header">Rekaman Deteksi (Menampilkan {{ detections|length }} dari {{ stats.total_records }} rekaman)</div>
            <div class="card-body table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead>
                        <tr>
                            <th>#</th><th>Waktu Deteksi</th><th>Objek Terdeteksi</th><th>Status</th><th>Gambar Bukti</th><th class="text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for detection in detections %}
                        <tr>
                            <th>{{ (current_page - 1) * 100 + loop.index }}</th>
                            <td>{{ detection['timestamp'] }}</td>
                            <td>{{ detection['detected_objects'] }}</td>
                            <td>
                                {% if detection['status'] == 'Lengkap' %}<span class="badge bg-success">Lengkap</span>{% else %}<span class="badge bg-danger">Tidak Lengkap</span>{% endif %}
                            </td>
                            <td>
                                <a href="#" class="btn btn-sm btn-outline-primary" 
                                   data-bs-toggle="modal" 
                                   data-bs-target="#imageModal"
                                   data-image-url="{{ url_for('static', filename=detection['image_path']) }}">
                                   Lihat Gambar
                                </a>
                            </td>
                            <td class="text-center">
                                <form action="{{ url_for('delete_detection', id=detection['id']) }}" method="post" onsubmit="return confirm('Anda yakin?');">
                                    <button type="submit" class="btn btn-danger btn-sm"><i class="bi bi-trash-fill"></i></button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="6" class="text-center p-5 text-muted"><h3>Tidak ada data ditemukan</h3><p>Coba ubah kriteria filter Anda atau tunggu deteksi baru.</p></td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if total_pages > 1 %}
            <div class="card-footer">
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center mb-0">
                        <li class="page-item {% if current_page <= 1 %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('history', page=current_page-1, search=search_query, status=status_filter, start_date=start_date, end_date=end_date) }}">&laquo;</a>
                        </li>
                        
                        {% set window = 2 %}
                        {% for p in range(1, total_pages + 1) %}
                            {% if p == 1 or p == total_pages or (current_page - window) <= p <= (current_page + window) %}
                                <li class="page-item {% if p == current_page %}active{% endif %}">
                                    <a class="page-link" href="{{ url_for('history', page=p, search=search_query, status=status_filter, start_date=start_date, end_date=end_date) }}">{{ p }}</a>
                                </li>
                            {% elif p == current_page - window - 1 or p == current_page + window + 1 %}
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                            {% endif %}
                        {% endfor %}

                        <li class="page-item {% if current_page >= total_pages %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('history', page=current_page+1, search=search_query, status=status_filter, start_date=start_date, end_date=end_date) }}">&raquo;</a>
                        </li>
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>
    </main>
    
    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">Gambar Bukti</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="" id="modalImage" class="img-fluid" alt="Gambar Deteksi">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const exportBtn = document.getElementById('exportBtn');
            const currentParams = new URLSearchParams(window.location.search);
            if (exportBtn) { exportBtn.href = `/export?${currentParams.toString()}`; }
            const imageModal = document.getElementById('imageModal');
            if(imageModal) {
                imageModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const imageUrl = button.getAttribute('data-image-url');
                    const modalImage = imageModal.querySelector('#modalImage');
                    modalImage.src = imageUrl;
                });
            }
        });
    </script>
</body>
</html>